<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Laptime vMix</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app">

  <!-- ÁREA DO LAPTIME -->
  <div id="laptime-container">
    <iframe id="laptime-frame" src="" frameborder="0"></iframe>
  </div>

  <!-- PAINEL DE CONTROLE -->
  <div id="control-panel">

    <h2>Painel Laptime</h2>

    <!-- LINK -->
    <div class="panel-section">
      <label>Link do Laptime</label>
      <input type="text" id="laptime-url" placeholder="Cole o link aqui">
      <button onclick="loadLaptime()">Carregar</button>
    </div>

    <!-- VISIBILIDADE -->
    <div class="panel-section">
      <h3>Exibição</h3>

      <label><input type="checkbox" checked data-toggle="race-name"> Nome da Corrida</label>
      <label><input type="checkbox" checked data-toggle="lap-count"> Nº de Voltas</label>
      <label><input type="checkbox" checked data-toggle="driver-number"> Nº Piloto</label>
      <label><input type="checkbox" checked data-toggle="lap-time"> Tempo da Volta</label>
      <label><input type="checkbox" checked data-toggle="best-lap"> Melhor Volta</label>
      <label><input type="checkbox" checked data-toggle="driver-name"> Nome do Piloto</label>
      <label><input type="checkbox" checked data-toggle="flag"> Bandeira</label>
    </div>

    <!-- LIMITADOR -->
    <div class="panel-section">
      <h3>Nome do Piloto</h3>
      <label>Máx. Caracteres</label>
      <input type="number" id="name-limit" value="12" min="3" max="30">
    </div>

    <!-- STATUS -->
    <div class="panel-section">
      <h3>Status</h3>
      <div id="status">Aguardando link...</div>
    </div>

  </div>

</div>

<script src="script.js"></script>
</body>
</html>

/* ===============================
   INSTRUÇÕES CSS
   ===============================

   - Toda estilização está neste arquivo
   - Pode alterar cores, tamanhos e fontes livremente
   - Fundo transparente para uso como overlay
   - Layout 75% Laptime / 25% Painel
   - Alinhamento à esquerda

*/

<style>

:root{
  --panel-bg: rgba(10,10,10,0.95);
  --panel-text: #ffffff;
  --accent: #00ff9c;
  --font: Arial, Helvetica, sans-serif;
}

*{
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body{
  background: transparent; /* Overlay */
  font-family: var(--font);
  overflow: hidden;
}

#app{
  width: 100vw;
  height: 100vh;
  display: flex;
}

/* ===============================
   LAPTIME
================================*/

#laptime-container{
  width: 75%;
  height: 100%;
  background: transparent;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 10px;
}

#laptime-frame{
  width: 100%;
  height: 100%;
  background: transparent;
}

/* ===============================
   PAINEL
================================*/

#control-panel{
  width: 25%;
  height: 100%;
  background: var(--panel-bg);
  color: var(--panel-text);
  padding: 15px;
  overflow-y: auto;
}

#control-panel h2{
  text-align: center;
  margin-bottom: 15px;
  color: var(--accent);
}

.panel-section{
  margin-bottom: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 15px;
}

.panel-section h3{
  margin-bottom: 10px;
  font-size: 14px;
  color: var(--accent);
}

.panel-section label{
  display: block;
  font-size: 13px;
  margin-bottom: 6px;
  cursor: pointer;
}

.panel-section input[type="text"],
.panel-section input[type="number"]{
  width: 100%;
  padding: 6px;
  margin-top: 5px;
  border: none;
  border-radius: 4px;
}

.panel-section button{
  width: 100%;
  margin-top: 8px;
  padding: 7px;
  background: var(--accent);
  border: none;
  font-weight: bold;
  cursor: pointer;
}

.panel-section button:hover{
  opacity: 0.8;
}

#status{
  font-size: 12px;
  color: #aaa;
}

</style>

<script>
/* ===============================
   SCRIPT
   ===============================

   - Controla iframe
   - Injeta CSS
   - Ativa/desativa campos
   - Limita nome

*/

const frame = document.getElementById('laptime-frame');
const statusEl = document.getElementById('status');

function loadLaptime(){

  const url = document.getElementById('laptime-url').value;

  if(!url){
    alert('Cole o link do laptime');
    return;
  }

  frame.src = url;

  statusEl.innerText = 'Carregando...';

  frame.onload = () => {
    statusEl.innerText = 'Laptime carregado';
    injectStyles();
  }
}

/* ===============================
   INJEÇÃO DE CSS
================================*/

function injectStyles(){

  try{

    const doc = frame.contentDocument || frame.contentWindow.document;

    const style = doc.createElement('style');

    style.innerHTML = `

    /* FUNDO TRANSPARENTE */
    body{
      background: transparent !important;
      text-align: left !important;
    }

    /* ALINHAMENTO */
    .container, table{
      margin-left: 0 !important;
    }

    /* ESCONDER POR PADRÃO */
    .lap-count,
    .driver-number,
    .best-lap{
      display: none;
    }

    `;

    doc.head.appendChild(style);

  }catch(e){
    statusEl.innerText = 'Erro: CORS bloqueado';
  }
}

/* ===============================
   CONTROLES
================================*/

document.querySelectorAll('[data-toggle]').forEach(box => {

  box.addEventListener('change', () => {

    const target = box.dataset.toggle;

    toggleElement(target, box.checked);

  });
});

function toggleElement(className, show){

  try{

    const doc = frame.contentDocument || frame.contentWindow.document;

    const els = doc.querySelectorAll(`.${className}`);

    els.forEach(el => {
      el.style.display = show ? '' : 'none';
    });

  }catch(e){
    console.log(e);
  }
}

/* ===============================
   LIMITADOR DE NOME
================================*/

const nameLimit = document.getElementById('name-limit');

nameLimit.addEventListener('input', applyNameLimit);

function applyNameLimit(){

  try{

    const doc = frame.contentDocument || frame.contentWindow.document;

    const max = parseInt(nameLimit.value);

    const names = doc.querySelectorAll('.driver-name');

    names.forEach(el => {

      let txt = el.innerText;

      if(txt.length > max){
        el.innerText = txt.substring(0, max) + '…';
      }

    });

  }catch(e){
    console.log(e);
  }
}

/* ===============================
   OBSERVADOR
   Atualiza quando tabela muda
================================*/

function observeChanges(){

  try{

    const doc = frame.contentDocument || frame.contentWindow.document;

    const target = doc.body;

    const observer = new MutationObserver(() => {
      applyNameLimit();
    });

    observer.observe(target, { childList:true, subtree:true });

  }catch(e){
    console.log(e);
  }
}

frame.addEventListener('load', observeChanges);

</script>
